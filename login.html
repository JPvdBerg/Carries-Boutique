// --- REDIRECT TO LOGIN IF NOT AUTHENTICATED ---

// Check immediately if Firebase Auth object is available
// Use a self-invoking function to run the check early
(function() {
    // We need to wait for Firebase Auth to initialize before checking the user state.
    // However, the full DOM might not be ready yet.
    // We create a temporary listener just for the initial auth check.

    const checkAuthStatus = () => {
        // Ensure firebase and firebase.auth() are ready
        if (typeof firebase !== 'undefined' && typeof firebase.auth === 'function') {
            const auth = firebase.auth();

            // Use onAuthStateChanged for the initial check too
            const unsubscribe = auth.onAuthStateChanged(user => {
                unsubscribe(); // Important: Stop listening after the first check

                const currentPage = window.location.pathname.split('/').pop(); // Get current HTML filename

                if (!user && currentPage !== 'login.html') {
                    // If NOT logged in AND NOT on login.html, redirect to login
                    console.log("User not logged in. Redirecting to login page.");
                    window.location.href = 'login.html';
                } else {
                    // User is logged in, or already on the login page.
                    // Let the rest of the app load normally.
                    console.log("User logged in or on login page. Proceeding.");
                }
            });
        } else {
            // If Firebase isn't ready yet, wait a moment and try again.
            // This is a basic fallback, might need adjustment if Firebase loads very slowly.
            console.warn("Firebase not ready yet for auth check, retrying...");
            setTimeout(checkAuthStatus, 100); // Try again in 100ms
        }
    };

    // Start the check
    checkAuthStatus();

})(); // Immediately invoke the function

// --- END REDIRECT LOGIC ---

// --- The rest of your app.js starts below (DOMContentLoaded listener) ---
document.addEventListener('DOMContentLoaded', () => {
    // ... (All your existing AOS, Feather, Cart, Checkout, and Auth UI update code goes here) ...

    // --- FIREBASE AUTHENTICATION LOGIC (UI Updates) ---
    // Make sure this section is INSIDE the DOMContentLoaded listener

    if (typeof firebase !== 'undefined') {
        const auth = firebase.auth(); // Get the auth instance again for UI updates

        const authContainer = document.getElementById('auth-container');
        const googleLoginBtn = document.getElementById('google-login-btn'); // Login button in NAVBAR
        const userInfoDiv = document.getElementById('user-info');
        const userDisplayNameSpan = document.getElementById('user-display-name');
        const logoutBtn = document.getElementById('logout-btn');

        // Note: Login button click handler might not be needed here anymore if login only happens on login.html
        // BUT keep it for now in case you add login options elsewhere.
        const handleGoogleLogin = () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
              .then((result) => {
                console.log("Logged in user:", result.user?.displayName || result.user?.email);
                // No redirect needed here if logged in from header, onAuthStateChanged handles UI
              }).catch((error) => {
                console.error("Google Sign-In Error:", error);
                alert(`Login failed: ${error.message}`);
              });
        };


        const handleLogout = () => {
            auth.signOut()
              .then(() => {
                console.log("User signed out.");
                // Redirect to login page after logout
                window.location.href = 'login.html';
              }).catch((error) => {
                console.error("Sign Out Error:", error);
                alert(`Logout failed: ${error.message}`);
              });
        };

        // Still add listener to navbar login button if it exists
         if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', handleGoogleLogin);
         }


        if (logoutBtn) {
            logoutBtn.addEventListener('click', handleLogout);
        }

        // Observer for Authentication State Changes (Handles UI updates in NAVBAR)
        auth.onAuthStateChanged((user) => {
            console.log("Auth state changed (UI update), user:", user); // Debug log

            const currentPage = window.location.pathname.split('/').pop();
            // Don't manipulate navbar auth buttons if we are on the login page itself
            if (currentPage === 'login.html') {
                return;
            }


            if (user) {
                // User is signed in.
                if (googleLoginBtn) googleLoginBtn.style.display = 'none';
                if (userInfoDiv) userInfoDiv.style.display = 'flex';
                if (userDisplayNameSpan) {
                   userDisplayNameSpan.textContent = user.displayName || user.email;
                }
            } else {
                 // User is signed out (This part might not run often if redirect happens first)
                if (googleLoginBtn) googleLoginBtn.style.display = 'inline-flex';
                if (userInfoDiv) userInfoDiv.style.display = 'none';
                if (userDisplayNameSpan) userDisplayNameSpan.textContent = '';
            }
             // Ensure feather icons are re-rendered
             setTimeout(feather.replace, 0);
        });

    } else {
        // Only log error if NOT on login page, as login page handles its own Firebase load error
        const currentPage = window.location.pathname.split('/').pop();
        if (currentPage !== 'login.html') {
            console.error("Firebase is not loaded or initialized on main page!");
        }
    }
    // --- END FIREBASE AUTHENTICATION LOGIC ---


    // ... (Rest of your code like INITIAL PAGE LOAD calls) ...
    // --- INITIAL PAGE LOAD ---
    updateCartIcon();
    renderCartPage();
    renderCheckoutSummary();
    feather.replace(); // Initial feather call
});